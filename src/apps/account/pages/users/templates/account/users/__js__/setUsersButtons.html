<script defer>
    let followBlockRequest = false

    function setUsersButtons({forms, follow_buttons, usernames}) {
        zip(forms, follow_buttons, usernames).forEach(
            ([form, follow_button, username]) => {
                setUserButton({form, follow_button, username})
            }
        )
    }
    function setUserButton({form, follow_button, username}) {
        if (form && follow_button && username)
            form.onsubmit = (e) => {
                e.preventDefault()
                const action = follow_button.innerText

                const form = new FormData()
                form.append('username', username.innerText)
                form.append('action', action)

                const headers = {
                    'X-CSRFToken': csrf_token,
                    'Content-Type': `multipart/form-data;
                    boundary=${form._boundary}`,
                }

                if (!followBlockRequest) {
                    async function _() {
                        followBlockRequest = true
                        const url = "{% url 'account:follow_user' %}"
                        const response = await axios.post(url, form, {headers})
                        const new_action = response.data.action

                        follow_button.innerHTML = new_action
                        follow_button.style.backgroundColor =
                            new_action === 'Follow' ? 'rgb(1, 135, 180)' : 'red'
                        followBlockRequest = false
                    }_()
                }
            }
    }
    setUsersButtons({
        forms: document.querySelectorAll('.follow_button__form'),
        follow_buttons: document.querySelectorAll('.follow_button__button'),
        usernames: document.querySelectorAll('.user__info-username-link-username'),
    })
</script>