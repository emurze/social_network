<script defer>
    function infinityPaginationHandler(query_strings = '') {
        const users_container = document.querySelector('.users__container')
        const extraMargin = -180  // depends on icon height

        let blockRequest = false
        let emptyPage = false
        let page = 1
        let elem = document.querySelector('[hx-trigger="revealed"]')
        let isCreated = false

        window.onscroll = () => {
            if (!blockRequest && !emptyPage) {
                const offset = elem => elem.getBoundingClientRect().top

                if (!isCreated) {
                    isCreated = true
                    setTimeout(() => {
                        isCreated = false
                        elem = document.querySelector('[hx-trigger="revealed"]')
                    }, 100)
                }
                const clientHeight = document.documentElement.clientHeight
                const last_post = elem ? offset(elem) : clientHeight+1
                const margin = last_post - extraMargin

                if (!blockRequest && !emptyPage && clientHeight > margin) {

                    users_container.insertAdjacentHTML(
                        'beforeend',
                        `{% include 'shared/loading_icon.html' %}`
                    )

                    elem && elem.removeAttribute('hx-trigger')
                    blockRequest = true
                    page++

                    {async function _() {
                        const url = `{% url 'account:download_users' %}`

                        console.log(`${url}?&page=${page}&${query_strings}`)

                        const response = await axios.get(
                            `${url}?page=${page}&${query_strings}`
                        )
                        const html = response.data

                        if (html === '') {
                            emptyPage = true
                        } else {
                            const elementFinder = document.createElement('div')
                            elementFinder.innerHTML = html

                            const elements = Array.from(elementFinder.children)
                            elements.forEach(
                                elem => {
                                    users_container.insertAdjacentElement(
                                        'beforeend', elem
                                    )
                                    setUserButton({
                                        form: elem.querySelector('.follow_button__form'),
                                        follow_button: elem.querySelector('.follow_button__button'),
                                        username: elem.querySelector('.user__info-username-link-username'),
                                    })
                                }
                            )

                            blockRequest = false
                        }

                        const loading_icon = document.querySelector('.loading_icon')
                        loading_icon.remove()
                    }_()}
                }
            }
        }
    }

    window.addEventListener(
        'DOMContentLoaded', () => infinityPaginationHandler()
    )
</script>