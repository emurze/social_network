<script defer>
    window.addEventListener('DOMContentLoaded', () => {
        const extraMargin = 0

        let blockRequest = false
        let emptyPage = false
        let page = 1

        let elem
        let isFirst = true
        let created = false


        window.onscroll = download_handler = () => {
            const offset = elem => elem.getBoundingClientRect().top

            if (isFirst) {
                elem = document.querySelector('[hx-trigger="revealed"]')
                isFirst = false
            } else if (!created) {
                created = true
                setTimeout(() => {
                    created = false
                    elem = document.querySelector('[hx-trigger="revealed"]')
                }, 10)
            }

            const last_post = elem ? offset(elem) : 0
            const margin = last_post - extraMargin

            if (document.documentElement.clientHeight > margin
                && !emptyPage && !blockRequest) {

                elem && elem.removeAttribute('hx-trigger')
                blockRequest = true
                page++

                {async function _() {
                    const url = `{% url 'post:download_posts' %}`
                    const response = await axios.get(
                        `${url}?&page=${page}`
                    )
                    const html = response.data

                    if (html === '') {
                        emptyPage = true
                    } else {
                        const posts_container = document.querySelector('.posts__container')
                        posts_container.insertAdjacentHTML('beforeend', html)

                        blockRequest = false
                        setReplyLinks({
                            reply_footer_form_set: document.querySelectorAll('.post__replies-footer'),
                            content_input_set: document.querySelectorAll('input[id="id_content"]'),
                            reply_link_set: document.querySelectorAll('.reply__link'),
                            post_replies_set: document.querySelectorAll('.post__replies'),
                        })
                        setLikeButtons({
                            like_forms: document.querySelectorAll('.like__button-form'),
                            like_button_container_set: document.querySelectorAll('.like__button-container'),
                            like_action_set: document.querySelectorAll('.like__button-action'),
                            like_counter_set: document.querySelectorAll('.like__button-like_counter'),
                            post_id_set: document.querySelectorAll('.like__button-post_id'),
                        })
                        setRepliesButtons({
                            reply_forms: document.querySelectorAll('.post__replies-footer-form'),
                            reply_list_set: document.querySelectorAll('.post__replies-list'),
                            post_id_set: document.querySelectorAll('.like__button-post_id'),
                            content_input_set: document.querySelectorAll('input[id="id_content"]'),
                            reply_link_counter_set: document.querySelectorAll('.reply__link-counter'),
                        })
                        setShowMore({
                            replies_list_all_set: document.querySelectorAll('.post__replies-list-all'),
                            replies_first_set: document.querySelectorAll('.reply_item-info--first'),
                            replies_show_more_set: document.querySelectorAll('.post__replies-show_more'),
                            post_id_set: document.querySelectorAll('.like__button-post_id'),
                        })
                    }
                }_()}
            }
        }
        {#download_handler()#}
    })
</script>